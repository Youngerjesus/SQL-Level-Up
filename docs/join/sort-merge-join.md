## 소트 머지 조인 (Sort Merge Join)

조인 칼럼에 인덱스가 없을 때, 대량의 데이터를 조인해야 할 때 우리는 NL 조인 대신 소트 머지 조인이나 해시 조인을 이용할 수 있다. 

해시 조인이 나온후에 소트 머지 조인의 쓰임새가 예전같지 않지만 해시 조인을 사용할 수 없는 환경에서 소트 머지 조인을 이용하면 여전히 유용하다. 

소트 머지 조인과 해시 조인을 설명하려면 먼저 PGA 에 대한 설명이 선행되어야 한다. 이를 SGA (Shared Global Area) 와 비교해서 먼저 이해해보자. 

***

### 1. SGA vs PGA 

공유 메모리 영역인 SGA 에 캐시된 데이터는 여러 프로세스가 공유할 수 있다. 하지만 동시에 엑세스 하려면 래치 획득이 필요하다. 

오라클 서버 프로세스는 SGA 에 공유된 데이터를 읽고 쓰면서 동시에 자신만의 고유 메모리 영역을 같는다. 각 오라클 서버 프로세스에 할당된 메모리 영역을 PGA (Process Global Area) 라고 부르며 프로세스에 종속적인 고유 데이터를 저장하는 용도로 사용된다. 

할당받은 PGA 공간이 부족하다면 디스크 영역인 TEMP 스페이스를 추가로 이용하기도 한다.

PGA 는 프로세스 마다 고유의 영역이므로 래치를 획득하지 않아도 된다. 그러므로 SGA 와 비교했을때 같은 양의 데이터를 읽는다고 하면 PGA 가 훨씬 빠르다. 

***
 
### 2. 기본 메커니즘

소트 머지 조인은 이름 그대로 두 단계로 이뤄진다. 

- 소트 단계: 양쪽 집합을 조인 칼럼 기준으로 정렬한다. 

- 머지 단계: 정렬된 양쪽 집합을 머지한다. 

여기서 주목할 점은 두 테이블을 조인한다고 했을 때 PGA 영역에 정렬된 테이블을 저장한다. 만약 PGA 공간이 부족하면 TEMP 공간을 사용한다.

그리고 조인할 때 PGA 에 매번 정렬된 테이블을 풀 스캔 하는게 아니라 정렬되었으므로 찾는 레코드를 쉽게 찾을 수 있다. Sort Area 자체가 인덱스 역할을 해준다고 생각하면 된다.   

***

### 3. 소트 머지 조인이 빠른 이유 

소트 머지 조인이 NL 조인과 비교했을 때 빠른 이유는 뭘까? 사전 준비 작업으로 정렬까지 하는데 

NL 조인에서 사용하는 인덱스를 이용하는 방식은 어떠한 레코드를 찾기 위해서 버퍼 캐시를 경유해서 테이블 랜덤 엑세스를 한다. 즉 레코드를 찾기 위해서 블록을 매번 가지고오는 작업을 한다는 것이다. 

그리고 미스가 나면 디스크에서 블록을 가지고 오기도 한다. 이것때문에 대량의 데이터에 있어서 NL 조인이 불리한 이유다. 

반면 소트 머지 조인은 PGA 영역에 데이터를 저장한 후 바로 엑세스 할 수 있다는 특징이 있다. 

물론 소트 머지 조인도 양쪽 테이블로부터 조인 대상 집합을 읽을 때 즉 정렬된 집합을 만들기 위해서 인덱스를 이용해서 버퍼 캐시에서 읽어들인다. 이 과정은 소트 머지 조인이라고 해서 피할 수 없는 것은 아니다.

***

### 4. 소트 머지 조인의 주용도

대부분 PGA 를 이용한 조인은 해시 조인이 소트 머지 조인보다 빠르다. 그렇다면 소트 머지 조인은 어디에 적합할까? 

- 조인 조건식이 '=' 가 아닌 대용량 데이터 조인일 경우

- 조인 조건식이 아예 없는 크로스 조인일 경우 

크로스 조인은 조인 조건이 없어서 두 집합에 대한 카테시안 곱을 만들어서 조인을 한다. 이 과정에서 NL 조인을 사용한다고 하면 반복적인 버퍼 캐시를 사용함으로 성능에 좋을리가 없다. 

하지만 소트 머지 조인을 이용한다면 PGA 에 저장한 후 래치 획득 없이 반복적으로 읽으면 되므로 성능상에 좋다.   

